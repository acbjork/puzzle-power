<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üß†¬†¬†I‚Äôm Puzzled¬†‚ÄºÔ∏è ‚Äî D.3</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body { font-family: sans-serif; padding: 1rem; background: #fff; }
    h1 { margin-bottom: 0; }
    .subtitle { font-size: 0.9em; color: #555; margin-top: 0.2em; margin-bottom: 1.5em; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { border: 1px solid #ccc; padding: 0.5rem; vertical-align: top; }
    th:first-child, td:first-child { text-align: left; }
    th:not(:first-child), td:not(:first-child) { text-align: center; }
    th { font-size: 1.1em; }
    textarea, pre { width: 100%; font-family: inherit; margin: 0; padding: 0.25rem; box-sizing: border-box; }
    pre { line-height: 1.1; padding: 0.25rem 0; white-space: pre-wrap; word-break: break-word; }
    .winner { background: #d4edda !important; font-weight: bold; }
    .tie { background: #fff3cd !important; font-weight: bold; }
    .warning { color: #b8860b; font-weight: bold; font-size: 0.8em; margin-bottom: 0.25rem; }
    .note { font-size: 0.75em; font-style: italic; margin-top: 2px; }
    .version { font-size: 0.8rem; color: #888; position: fixed; bottom: 4px; right: 8px; }
  </style>
</head>
<body>
  <h1 style="text-align:center;">üß†¬†¬†I‚Äôm Puzzled¬†‚ÄºÔ∏è</h1>
  <p class="subtitle" style="text-align:center; font-size: 0.9em; color: #555; margin-top: -0.3em; margin-bottom: 1.2em; padding-left: 0.8em;">If you ain‚Äôt first, you‚Äôre last</p>
  <p id="identityPrompt">Who are you?</p>
  <select id="playerSelect">
    <option value="">Select</option>
    <option value="Adam">Adam</option>
    <option value="Jonathan">Jonathan</option>
  </select>
  <div id="status" style="margin-top: 1rem; color: red;"></div>
  <table id="resultsTable" style="display:none;">
    <thead>
      <tr>
        <th>Puzzle</th>
        <th>Adam üåµ</th>
        <th>Jonathan üí©</th>
      </tr>
    </thead>
    <tbody id="puzzleBody"></tbody>
  </table>
  <div class="version" id="versionFooter">vD.3.2.4</div>
<script>
const supabase = window.supabase.createClient(
  "https://iqhgsdpqqshfeiqrkrqw.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlxaGdzZHBxcXNoZmVpcXJrcnF3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc4NjExMDAsImV4cCI6MjA2MzQzNzEwMH0.W3eH88RD9s3pmuVlA-H7VIfVWLq_ymtj22JLd2f9Cec"
);
const today = new Date().toISOString().split("T")[0];
const puzzles = ["Connections", "Wordle", "Mini Crossword", "Keyword", "Strands"];
const playerKey = "puzzle-player";
let currentPlayer = localStorage.getItem(playerKey) || "";

function parseWordle(text) {
  const m = text.match(/Wordle\s+([\d,]+)\s+(\d|X)\/6/i);
  if (!m) return null;
  return { puzzle: parseInt(m[1].replace(/,/g, "")), score: m[2] === "X" ? 7 : parseInt(m[2]) };
}
function parseConnections(text) {
  const rowCount = (text.match(/[üü®üü¶üü©üü™]{4}/g) || []).length;
  const purpleLine = text.split(/\r?\n/).findIndex(row => row.trim() === "üü™üü™üü™üü™");
  return { guesses: rowCount, purpleLine };
}
function parseStrands(text) {
  const hints = (text.match(/üí°/g) || []).length;
  const spangramLine = text.split(/\r?\n/).findIndex(row => row.includes("üü°"));
  const words = (text.match(/[‚Äú‚Äù"][^‚Äù‚Äù"]+[‚Äù‚Äù"]/g) || []).length;
  return { words, hints, spangramLine };
}
function parseKeyword(text) {
  const guesses = parseInt(text.match(/\|(\d+) guesses/i)?.[1] || "999");
  const t = text.match(/\|(\d+):(\d{2})/) || [];
  const seconds = parseInt(t[1] || 0) * 60 + parseInt(t[2] || 0);
  return { guesses, seconds };
}
function parseMiniDate(text) {
  const match = text.match(/(\d{1,2}\/\d{1,2}\/\d{4})/);
  if (!match) return null;
  return new Date(match[1]);
}
function isSameEasternDate(targetDate) {
  const now = new Date();
  const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
  const eastern = new Date(utc + (-4 * 3600000));
  return targetDate.getFullYear() === eastern.getFullYear() &&
         targetDate.getMonth() === eastern.getMonth() &&
         targetDate.getDate() === eastern.getDate();
}

function determineWinner(puzzle, a, j) {
  if (!a || !j) return {};
  if (puzzle === "Wordle") {
    const pa = parseWordle(a), pj = parseWordle(j);
    if (!pa || !pj) return {};
    if (pa.puzzle !== pj.puzzle) return { warn: "Discordant puzzle versions" };
    if (pa.score < pj.score) return { winner: "Adam" };
    if (pj.score < pa.score) return { winner: "Jonathan" };
    return { winner: "Tie" };
  }
  if (puzzle === "Connections") {
    const ca = parseConnections(a), cj = parseConnections(j);
    if (ca.guesses < cj.guesses) return { winner: "Adam" };
    if (cj.guesses < ca.guesses) return { winner: "Jonathan" };
    if (ca.purpleLine < cj.purpleLine) return { winner: "Adam", note: "Won on tiebreaker (purple row)" };
    if (cj.purpleLine < ca.purpleLine) return { winner: "Jonathan", note: "Won on tiebreaker (purple row)" };
    return { winner: "Tie" };
  }
  if (puzzle === "Strands") {
    const sa = parseStrands(a), sj = parseStrands(j);
    if (sa.words < sj.words) return { winner: "Adam" };
    if (sj.words < sa.words) return { winner: "Jonathan" };
    if (sa.hints < sj.hints) return { winner: "Adam", note: "Won on tiebreaker (hints)" };
    if (sj.hints < sa.hints) return { winner: "Jonathan", note: "Won on tiebreaker (hints)" };
    if (sa.spangramLine < sj.spangramLine) return { winner: "Adam", note: "Won on tiebreaker (Spangram)" };
    if (sj.spangramLine < sa.spangramLine) return { winner: "Jonathan", note: "Won on tiebreaker (Spangram)" };
    return { winner: "Tie" };
  }
  if (puzzle === "Keyword") {
    const ka = parseKeyword(a), kj = parseKeyword(j);
    if (ka.guesses < kj.guesses) return { winner: "Adam" };
    if (kj.guesses < ka.guesses) return { winner: "Jonathan" };
    if (ka.seconds < kj.seconds) return { winner: "Adam", note: "Won on tiebreaker (time)" };
    if (kj.seconds < ka.seconds) return { winner: "Jonathan", note: "Won on tiebreaker (time)" };
    return { winner: "Tie" };
}; if (kj.guesses < ka.guesses) return { winner: "Jonathan" }; if (ka.seconds < kj.seconds) return { winner: "Adam", note: "Won on tiebreaker (time)" }; if (kj.seconds < ka.seconds) return { winner: "Jonathan", note: "Won on tiebreaker (time)" }; return { winner: "Tie" };
    if (kj.guesses < ka.guesses) return { winner: "Jonathan" };
    if (ka.seconds < kj.seconds) return { winner: "Adam", note: "Won on tiebreaker (time)" };
    if (kj.seconds < ka.seconds) return { winner: "Jonathan", note: "Won on tiebreaker (time)" };
    return { winner: "Tie" };
  }
  return {};
}

const status = document.getElementById("status");
const playerSelect = document.getElementById("playerSelect");
const puzzleBody = document.getElementById("puzzleBody");
const resultsTable = document.getElementById("resultsTable");

function setPlayer(name) {
  localStorage.setItem(playerKey, name);
  currentPlayer = name;
  document.getElementById("identityPrompt").innerHTML = `You are logged in as ${name}. <a href="#" onclick="resetPlayer()">Not you?</a>`;
  playerSelect.style.display = "none";
  load();
}
function resetPlayer() {
  localStorage.removeItem(playerKey);
  location.reload();
}
playerSelect.onchange = () => {
  if (playerSelect.value) setPlayer(playerSelect.value);
};

async function submitResult(puzzle, player, inputId) {
  const value = document.getElementById(inputId).value.trim();
  if (!value) return;
  const { error } = await supabase.from("results").insert([{ date: today, player, puzzle_name: puzzle, raw_result: value }]);
  if (error) {
    status.textContent = "Error: " + error.message;
    console.error("Insert error:", error);
  } else {
    load();
  }
}

async function load() {
  const { data, error } = await supabase.from("results").select("*").eq("date", today);
  if (error || !data) {
    status.textContent = "Error loading results";
    return;
  }
  const map = {};
  data.forEach(r => {
    if (!map[r.puzzle_name]) map[r.puzzle_name] = {};
    map[r.puzzle_name][r.player] = r.raw_result;
  });

  puzzleBody.innerHTML = "";
  puzzles.forEach(puzzle => {
    const row = document.createElement("tr");
    const a = map[puzzle]?.Adam || "";
    const j = map[puzzle]?.Jonathan || "";
    const winnerData = determineWinner(puzzle, a, j);
    row.innerHTML = `
      <td>${puzzle}</td>
      <td class="${winnerData.winner === "Adam" ? "winner" : winnerData.winner === "Tie" ? "tie" : ""}">
        ${renderCell(puzzle, "Adam", a, winnerData)}
      </td>
      <td class="${winnerData.winner === "Jonathan" ? "winner" : winnerData.winner === "Tie" ? "tie" : ""}">
        ${renderCell(puzzle, "Jonathan", j, winnerData)}
      </td>`;
    puzzleBody.appendChild(row);
  });

  resultsTable.style.display = "table";
}

function renderCell(puzzle, player, raw, winnerData) {
  const editable = player === currentPlayer && !raw;
  const id = `input-${puzzle}-${player}`.replace(/\s+/g, "");
  const note = winnerData?.note && winnerData.winner === player ? `<div class="note">${winnerData.note}</div>` : "";
  const warn = (puzzle === "Wordle" && winnerData?.warn) ? `<div class="warning">${winnerData.warn}</div>` :
               (puzzle === "Mini Crossword" && raw && !isSameEasternDate(parseMiniDate(raw) || new Date())) ? `<div class="warning">Discordant puzzle date</div>` : "";

  if (editable) {
    return `<textarea id="${id}" rows="4"></textarea><br><button onclick="submitResult('${puzzle}','${player}','${id}')">Submit</button>`;
  } else {
    return `${warn}<pre>${raw}</pre>${note}`;
  }
}

if (currentPlayer) setPlayer(currentPlayer);
</script>
</body>
</html>
<script>
function renderTable(data) {
  const map = {};
  data.forEach(r => {
    if (!map[r.puzzle_name]) map[r.puzzle_name] = {};
    map[r.puzzle_name][r.player] = r.raw_result;
  });

  puzzleBody.innerHTML = "";
  puzzles.forEach(puzzle => {
    const row = document.createElement("tr");
    const a = map[puzzle]?.Adam || "";
    const j = map[puzzle]?.Jonathan || "";
    const winnerData = determineWinner(puzzle, a, j);
    row.innerHTML = `
      <td>${puzzle}</td>
      <td class="${winnerData.winner === "Adam" ? "winner" : winnerData.winner === "Tie" ? "tie" : ""}">
        ${renderCell(puzzle, "Adam", a, winnerData)}
      </td>
      <td class="${winnerData.winner === "Jonathan" ? "winner" : winnerData.winner === "Tie" ? "tie" : ""}">
        ${renderCell(puzzle, "Jonathan", j, winnerData)}
      </td>`;
    puzzleBody.appendChild(row);
  });

  resultsTable.style.display = "table";
}
</script>