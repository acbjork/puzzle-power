<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ðŸ§  Puzzle Power â€“ C.4.2</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>
<body>
  <h1>ðŸ§  Puzzle Power â€“ C.4.2</h1>
  <p id="identityPrompt">Who are you?</p>
  <select id="playerSelect">
    <option value="">Select</option>
    <option value="Adam">Adam</option>
    <option value="Jonathan">Jonathan</option>
  </select>
  <table id="resultsTable" style="display:none;">
    <thead><tr><th>Puzzle</th><th>Adam</th><th>Jonathan</th></tr></thead>
    <tbody id="puzzleBody"></tbody>
  </table>

<script>
const supabase = supabase.createClient(
  "https://iqhgsdpqqshfeiqrkrqw.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlxaGdzZHBxcXNoZmVpcXJrcnF3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc4NjExMDAsImV4cCI6MjA2MzQzNzEwMH0.W3eH88RD9s3pmuVlA-H7VIfVWLq_ymtj22JLd2f9Cec"
);

const today = new Date().toISOString().split("T")[0];
const playerKey = "puzzle-player";
let currentPlayer = localStorage.getItem(playerKey) || "";

const puzzleList = ["Connections", "Wordle"];
const prompt = document.getElementById("identityPrompt");
const select = document.getElementById("playerSelect");
const table = document.getElementById("resultsTable");
const body = document.getElementById("puzzleBody");

async function loadData() {
  const { data } = await supabase.from("results")
    .select("puzzle_name, raw_result, player").eq("date", today);
  const map = {};
  data.forEach(r => {
    if (!map[r.puzzle_name]) map[r.puzzle_name] = {};
    map[r.puzzle_name][r.player] = r.raw_result;
  });

  body.innerHTML = "";
  puzzleList.forEach(puzzle => {
    const a = map[puzzle]?.Adam || "";
    const j = map[puzzle]?.Jonathan || "";
    const row = document.createElement("tr");
    row.innerHTML = `<td>${puzzle}</td><td></td><td></td>`;

    ["Adam", "Jonathan"].forEach((player, i) => {
      const cell = row.children[i + 1];
      const val = player === "Adam" ? a : j;
      const div = document.createElement("div");

      const pre = document.createElement("pre");
      pre.textContent = val;

      if (player === currentPlayer) {
        const ta = document.createElement("textarea");
        ta.value = val;
        ta.style.display = val ? "none" : "block";
        pre.style.display = val ? "block" : "none";

        const sb = document.createElement("button");
        sb.textContent = "Submit";
        sb.className = "submit-btn";
        sb.style.display = val ? "none" : "inline-block";
        sb.onclick = async () => {
          const value = ta.value.trim();
          if (!value) return;
          await supabase.from("results").upsert([{
            date: today, puzzle_name: puzzle, player, raw_result: value
          }]);
          loadData();
        };

        const eb = document.createElement("button");
        eb.textContent = "Edit";
        eb.className = "edit-btn";
        eb.style.display = val ? "inline-block" : "none";
        eb.onclick = () => {
          ta.style.display = "block";
          pre.style.display = "none";
          sb.style.display = "inline-block";
          eb.style.display = "none";
        };

        div.appendChild(pre);
        div.appendChild(ta);
        div.appendChild(sb);
        div.appendChild(eb);
      } else {
        div.appendChild(pre);
      }

      cell.appendChild(div);
    });

    body.appendChild(row);
  });

  table.style.display = "table";
}

function showIdentity(name) {
  currentPlayer = name;
  localStorage.setItem(playerKey, name);
  prompt.innerHTML = `You are logged in as ${name}. <span style="color:#007aff;cursor:pointer;" onclick="resetIdentity()">Not you?</span>`;
  select.style.display = "none";
  loadData();
}

function resetIdentity() {
  localStorage.removeItem(playerKey);
  location.reload();
}

if (currentPlayer) {
  showIdentity(currentPlayer);
}

select.onchange = () => {
  const name = select.value;
  if (name) showIdentity(name);
};
</script>
</body>
</html>